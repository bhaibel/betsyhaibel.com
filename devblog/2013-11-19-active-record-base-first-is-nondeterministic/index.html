<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <!-- Use title if it's in the page YAML frontmatter -->
        <title>ActiveRecord::Base.first is nondeterministic</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link rel="stylesheet" href="/css/normalize.css">
        <link rel="stylesheet" href="/css/screen.css">
        <link rel="stylesheet" href="/css/pygments.css">

        <script src="js/vendor/modernizr-2.6.1.min.js"></script>
    </head>
    <body class='' >
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
        <![endif]-->
        <div class="container">
            <header>
                <h1> Betsy Haibel has an Online Presence</h1>
            </header>

            <nav>
              <ul>
                <li>
                  <a href="/writing">Writing</a>
                </li>
                <li>
                  <a href="https://github.com/bhaibel">Code</a>
                </li>
                <li>
                  <a href="https://twitter.com/betsythemuffin">Twitter</a>
                </li>
                <li>
                  <a href="/resume">Resume</a>
                </li>
              </ul>
            </nav>

          <div class="content">
            <p>Recently, at the office, something happened that baffled me. I was doing some third-party integration testing from the rails console, which required multiple test runs of this approximate form:</p>
<pre class="highlight ruby">    <span class="k">def</span> <span class="nf">test_run</span>
      <span class="n">reload!</span>
      <span class="no">TestedModel</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">update_attribute</span> <span class="ss">:callback_triggering_attr</span><span class="p">,</span> <span class="kp">nil</span>
      <span class="no">TestedModel</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">update_attribute</span> <span class="ss">:callback_triggering_attr</span><span class="p">,</span> <span class="s1">'a real value'</span>
    <span class="k">end</span>
</pre>

<p>After a test run succeeded in having the third-party effect I wanted, I checked to see if the callback had also triggered the subsequent resource updates I wanted:</p>
<pre class="highlight ruby">    <span class="no">TestedModel</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">some_other_attribute</span>
</pre>

<p><strong>NOPE.</strong></p>

<p><img alt="nope-rocket.gif" src="http://captainawkwarddotcom.files.wordpress.com/2013/08/noperocket.gif" /></p>

<p>Several very confused pry-debugger sessions later, I noted that the ids returned by my <code>self</code> call in the middle of prying and the id returned by <code>TestedModel.first</code> &hellip; did not match.</p>

<p>It turns out that <code>ActiveRecord::Base.first</code> is nondetermininistic. It generates SQL that looks something like <code>select * from table_name limit 1</code>, and the order of selects when no specific order clause is included is nondeterministic in the official SQL specification. It&rsquo;s easy to forget that. The default order is <em>typically</em> creation order and creation order <em>typically</em> tracks ascending order by id in a Rails application. However, because computers are computers, it&rsquo;s important to remember that <strong>typically != always</strong>.</p>

<p>Amusingly, <code>ActiveRecord::Base.last</code>&lt;% end %&gt;
 <em>is</em> deterministic. In order to retrieve the &ldquo;last&rdquo; record while still imposing a limit of 1 record retrieved, a descending order on <em>some</em> attribute must be imposed, like so: <code>select * from table_name order by table_name.id desc limit 1</code>.</p>

<p>A quick check of the Rails docs revealed that the behavior of <code>ActiveRecord::Base.first</code>
 has been changed/corrected in Rails 4 so that a specific order clause on the primary key is included. I look forward to its behavior confusing fewer people in the future.</p>

          </div>

          <footer>
            <p>&copy; 2014 Betsy Haibel
            </p>
          </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.8.0.min.js"><\/script>')</script>
        <script src="js/plugins.js"></script>
        <script src="js/main.js"></script>

        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52442215-1', 'auto');
  ga('send', 'pageview');

</script>
    </body>
</html>
